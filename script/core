#!/bin/bash
# Helper to start Home Assistant Core inside the devcontainer

# Stop on errors
set -e

WD="${WORKSPACE_DIRECTORY:=/workspaces/frontend}"

if [ -z "${DEVCONTAINER}" ]; then
  echo "This task should only run inside a devcontainer, for local install HA Core in a venv."
  exit 1
fi

# Default to installing (or upgrading to) dev branch
archiveURL="https://github.com/home-assistant/core/archive"
installURL="${archiveURL}/refs/heads/dev.tar.gz"

while getopts "b:c:t:sh" opt; do
  case $opt in
    b) # Branch
      installURL="${archiveURL}/refs/heads/${OPTARG}.tar.gz"
      ;;
    c) # Commit SHA
      installURL="${archiveURL}/${OPTARG}.tar.gz"
      ;;
    t) # Tag
      installURL="${archiveURL}/refs/tags/${OPTARG}.tar.gz"
      ;;
    s) # Skip (use current install)
      installURL=""
      ;;
    h) # Help
      echo "Usage: core [-b <branch>|-c <commit>|-t <tag>|-s|-h]"
      echo -n "Install and run core at the given branch, tag, or commit. The dev branch is used if no option is specified."
      echo "The -s flag skips the install/upgrade, using whatever version is currently installed."
      exit 0
      ;;
    *)
      echo "Try $0 -h for help" >&2
      exit 1
      ;;
  esac
done

if [ -n "$installURL" ]; then
  echo "Installing Home Asstant core from dev."
  python3 -m pip install --upgrade colorlog "$installURL"
fi

if [ ! -d "${WD}/config" ]; then
  echo "Creating default configuration."
  mkdir -p "${WD}/config";
  hass --script ensure_config -c config
  echo "demo:

logger:
  default: info
  logs:
    homeassistant.components.frontend: debug
" >> "${WD}/config/configuration.yaml"

  if [ -n "${HASSIO}" ]; then
  echo "
# frontend:
#   development_repo: ${WD}

hassio:
  development_repo: ${WD}" >> "${WD}/config/configuration.yaml"
  else
  echo "
frontend:
  development_repo: ${WD}

# hassio:
#   development_repo: ${WD}" >> "${WD}/config/configuration.yaml"
  fi

  if [ -n "${CODESPACES}" ]; then
  echo "
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
" >> "${WD}/config/configuration.yaml"
  fi
fi

hass -c "${WD}/config"
